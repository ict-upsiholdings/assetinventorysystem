<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Permohonan Aset</title>

<link rel="icon" type="image/x-icon" href="img/UHSB-Logo-resize.png">
<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#1A2350;
  --bg2:#1FA2FF;
  --card:#F4F6F8;
  --accent:#12D8FA;
  --muted:#6B7280;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'League Spartan',sans-serif;}
body{
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  min-height: 100vh;
  padding: 20px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}
.form-container{
  max-width:500px;
  width:100%;
  background: var(--card);
  padding:30px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
.logo-container{
  display:flex;
  justify-content:center;
  margin-bottom:20px;
}
.logo-container img{
  height:120px;
  width:auto;
}
h1{
  text-align:center;
  margin-bottom:20px;
  color: var(--bg1);
}
label{
  font-weight:600;
  display:block;
  margin-top:12px;
  margin-bottom:4px;
}
input,select,button{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:14px;
}
button{
  background:linear-gradient(135deg,var(--bg2),var(--accent));
  color:white;
  border:none;
  cursor:pointer;
  margin-top:14px;
  font-weight:600;
}
button:hover{opacity:.9}
button:disabled{opacity:.6;cursor:not-allowed}

.hidden{display:none}

#nameDropdown{
  position:absolute;
  z-index:1000;
  background:white;
  border:1px solid #ccc;
  width:calc(100% - 22px);
  max-height:180px;
  overflow-y:auto;
  border-radius:8px;
}
.name-option{
  padding:8px;
  cursor:pointer;
}
.name-option:hover{background:#eef6ff}
.name-highlight{
  font-weight:bold;
  color:var(--bg2);
}
.message{
  margin-top:12px;
  padding:10px;
  border-radius:10px;
  display:none;
  text-align:center;
  font-weight:600;
}
.success{background:#D1FAE5;color:#065F46}
.error{background:#FEE2E2;color:#991B1B}
.warning{background:#FEF3C7;color:#92400E}
</style>
</head>

<body>

<div class="form-container">

  <div class="logo-container">
    <img src="Screenshot 2026-01-14 161757.png" alt="Logo">
  </div>

  <h1>Sistem Permohonan Aset</h1>

  <form id="assetForm">

    <label>Nama <span style="color:red">*</span></label>
    <input type="text" id="namaInput" placeholder="Taip untuk cari nama" autocomplete="off" required>
    <div id="nameDropdown" class="hidden"></div>

    <label>Jabatan <span style="color:red">*</span></label>
    <input type="text" id="jabatan" required>

    <label id="jenisLabel">Jenis Aset</label>
    <select id="jenisSelect">
      <option value="">-- Pilih --</option>
      <option value="alat_tulis">Alat Tulis</option>
      <option value="kenderaan">Kenderaan</option>
      <option value="projektor">Projektor</option>
    </select>

    <!-- Alat Tulis -->
    <input type="text" id="item" class="hidden" placeholder="">
    <input type="number" id="kuantiti" class="hidden" placeholder="Kuantiti">

    <!-- Kenderaan -->
    <input type="text" id="jenisKenderaan" class="hidden" placeholder="Jenis Kenderaan">
    <input type="text" id="masa" class="hidden" placeholder="Masa">
    <input type="text" id="namaPemandu" class="hidden" placeholder="Nama Pemandu">
    <input type="text" id="lokasi" class="hidden" placeholder="Lokasi">
    <input type="text" id="tujuan" class="hidden" placeholder="Tujuan">
    <input type="number" id="bacaanOdo" class="hidden" placeholder="Bacaan Odometer (km)">

    <!-- Projektor -->
    <input type="text" id="noProjektor" class="hidden" placeholder="No Projektor">

    <input type="hidden" id="timestamp">

    <button type="submit" id="submitBtn">Hantar</button>
  </form>

  <div id="message" class="message"></div>

</div>

<script>
const NAMES_API = 'https://script.google.com/macros/s/AKfycbx6kMJIKKJOj3wOE71pALIxQxT0gTI9khFoTjNH8BSiSxVEhn4QiMpFpPXbUX8SrQDiXg/exec';
const POST_API = {
  alat_tulis:"https://script.google.com/macros/s/AKfycbwBQtsg3QjNGMM8z3wZw61VS0jkGKP2BHc6j2Du7HklazaiqGEemal1JvwPJ-7EzBTLLQ/exec",
  kenderaan:"https://script.google.com/macros/s/AKfycbxvMxEIGXqZA8mlgYLsMFgYkNNFekaqOAhucDPfNhlsZwTj5P-470ar73BaQSo_AnsO4w/exec",
  projektor:"https://script.google.com/macros/s/AKfycby0vI9Snx7XFiakkkBoO-5MeJdli3-IwksN1wP-9OIRi8Ws4_L5QJSlJnKs80Tk6DcRKw/exec"
};
let namesData=[];

async function loadNames(){
  const res=await fetch(NAMES_API);
  const data=await res.json();
  namesData = data.map(r=>{
    const o={};
    for(let k in r) o[k.trim()]=r[k];
    return o;
  });
}

function highlight(text,term){
  return text.replace(new RegExp(`(${term})`,'ig'),'<span class="name-highlight">$1</span>');
}

function setupAutocomplete(){
  const nama=document.getElementById('namaInput');
  const jab=document.getElementById('jabatan');
  const drop=document.getElementById('nameDropdown');

  nama.addEventListener('input',()=>{
    const q=nama.value.trim();
    if(!q){drop.classList.add('hidden');jab.value='';return;}
    const filtered=namesData.filter(x=>x.Nama.toLowerCase().includes(q.toLowerCase()));
    drop.innerHTML='';
    filtered.forEach(item=>{
      const d=document.createElement('div');
      d.className='name-option';
      d.innerHTML=highlight(item.Nama,q);
      d.onclick=()=>{
        nama.value=item.Nama;
        jab.value = item.Jabatan || item.Dept || '';
        drop.classList.add('hidden');
      };
      drop.appendChild(d);
    });
    drop.classList.toggle('hidden',filtered.length===0);
  });

  document.addEventListener('click',e=>{
    if(!drop.contains(e.target) && !nama.contains(e.target))
      drop.classList.add('hidden');
  });
}

// --- Fields ---
const item = document.getElementById('item');
const kuantiti = document.getElementById('kuantiti');
const jenisKenderaan = document.getElementById('jenisKenderaan');
const masa = document.getElementById('masa');
const namaPemandu = document.getElementById('namaPemandu');
const lokasi = document.getElementById('lokasi');
const tujuan = document.getElementById('tujuan');
const bacaanOdo = document.getElementById('bacaanOdo');
const noProjektor = document.getElementById('noProjektor');
const jenisSelect = document.getElementById('jenisSelect');
const namaInput = document.getElementById('namaInput');
const jabatan = document.getElementById('jabatan');
const timestamp = document.getElementById('timestamp');
const submitBtn = document.getElementById('submitBtn');
const jenisLabel = document.getElementById('jenisLabel');

function updateFieldsByJenis(jenis){
  // Hide all dynamic fields
  const allFields = [item, kuantiti, jenisKenderaan, masa, namaPemandu, lokasi, tujuan, bacaanOdo, noProjektor];
  allFields.forEach(f => f.classList.add('hidden'));
  
  // Reset values
  allFields.forEach(f => f.value = '');

  if(jenis === 'alat_tulis'){
    item.placeholder = 'Jenis Alat';
    item.classList.remove('hidden');
    kuantiti.classList.remove('hidden');
  }

  if(jenis === 'kenderaan'){
    jenisKenderaan.classList.remove('hidden');
    masa.classList.remove('hidden');
    namaPemandu.classList.remove('hidden');
    lokasi.classList.remove('hidden');
    tujuan.classList.remove('hidden');
    bacaanOdo.classList.remove('hidden');
  }

  if(jenis === 'projektor'){
    noProjektor.classList.remove('hidden');
  }
}

jenisSelect.addEventListener('change', function(){
  updateFieldsByJenis(this.value);
});

// --- Form submit ---
document.getElementById('assetForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const jenis = jenisSelect.value;
  if(!jenis) return showMessage('Sila pilih jenis aset','warning');
  submitBtn.disabled = true;
  timestamp.value = new Date().toLocaleString('ms-MY');
  
  let data = {
    nama: namaInput.value,
    jabatan: jabatan.value,
    timestamp: timestamp.value
  };

  // Build data based on jenis
  if(jenis === 'alat_tulis'){
    data.jenis_alatan = item.value || '-';
    data.kuantiti = kuantiti.value || '-';
  } else if(jenis === 'kenderaan'){
    data.jenis_kenderaan = jenisKenderaan.value || '-';
    data.masa = masa.value || '-';
    data.nama_pemandu = namaPemandu.value || '-';
    data.lokasi = lokasi.value || '-';
    data.tujuan = tujuan.value || '-';
    data.bacaan_odometer = bacaanOdo.value || '-';
  } else if(jenis === 'projektor'){
    data.no_projektor = noProjektor.value || '-';
  }

  const res = await fetch(POST_API[jenis], {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({data: JSON.stringify(data)})
  });
  const r = await res.json();
  r.status==='success'
    ? showMessage('✓ Permohonan berjaya','success')
    : showMessage('✗ Gagal hantar','error');
  submitBtn.disabled = false;
  e.target.reset();
});

function showMessage(msg,type){
  const el=document.getElementById('message');
  el.textContent=msg;
  el.className=`message ${type}`;
  el.style.display='block';
  if(type==='success') setTimeout(()=>el.style.display='none',5000);
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadNames();
  setupAutocomplete();
  
  // --- QR auto-set jenis dari URL ---
  const params = new URLSearchParams(window.location.search);
  let jenisParam = params.get('jenis');
  
  // Flexible mapping
  let mappedJenis = '';
  if(jenisParam === 'AlatTulis' || jenisParam === 'AlatTulis2026'){
    mappedJenis = 'alat_tulis';
  } else if(jenisParam === 'Kenderaan' || jenisParam === 'Kenderaan2026'){
    mappedJenis = 'kenderaan';
  } else if(jenisParam === 'Projektor' || jenisParam === 'Projektor2026'){
    mappedJenis = 'projektor';
  }
  
  if(mappedJenis){
    jenisSelect.value = mappedJenis;
    updateFieldsByJenis(mappedJenis);
    jenisSelect.disabled = true;
    jenisSelect.style.pointerEvents = 'none';
    jenisSelect.style.opacity = '0.6';
    jenisSelect.style.backgroundColor = '#e5e7eb';
    jenisLabel.textContent = "Jenis Aset: " + jenisParam;
    jenisLabel.style.color = '#059669';
  }
});
</script>

</body>
</html>

