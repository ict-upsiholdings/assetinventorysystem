<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Portal - Sistem Permohonan</title>

<link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{
  --bg1:#1A2350;
  --bg2:#1FA2FF;
  --card:#F4F6F8;
  --accent:#12D8FA;
  --muted:#6B7280;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'League Spartan',sans-serif;}
body{
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  min-height:100vh;
  padding:20px;
}
.container{max-width:1200px;margin:auto;}
.header{
  background:var(--card);
  padding:30px;
  border-radius:20px;
  margin-bottom:30px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
  position:relative;
}
.header h1{color:var(--bg1);font-size:32px;margin-bottom:10px;}
.header .subtitle{color:#4A4A4A;font-size:16px;}
.header button.logout{
  position:absolute;
  top:30px;
  right:30px;
  background:#f87171;
  color:#fff;
  border:none;
  padding:12px 20px;
  border-radius:10px;
  cursor:pointer;
}

.tabs{display:flex;gap:10px;margin-bottom:30px;}
.tab{
  flex:1;
  padding:15px;
  background:rgba(255,255,255,0.2);
  border:2px solid transparent;
  border-radius:12px;
  color:white;
  font-size:18px;
  font-weight:600;
  cursor:pointer;
  text-align:center;
  transition:.3s;
}
.tab.active{background:var(--card);color:var(--bg1);border-color:var(--accent);}
.content-section{display:none;}
.content-section.active{display:block;}

.qr-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;
}
.qr-card{
  background:var(--card);
  padding:25px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
  text-align:center;
}
.qr-card h3{color:var(--bg1);margin-bottom:10px;}
.qr-code-container{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin:15px 0;
  display:inline-block;
}
.download-btn{
  width:100%;
  padding:12px;
  background:linear-gradient(135deg,var(--bg2),var(--accent));
  color:#fff;
  border:none;
  border-radius:10px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}

.table-container{overflow-x:auto;background:var(--card);border-radius:12px;}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:10px;border-bottom:1px solid #ddd;}
th{background:var(--bg1);color:white;}
.loading{text-align:center;color:var(--muted);padding:20px;}

.filter-bar{display:flex;gap:15px;margin-bottom:15px;}
.filter-bar select{padding:10px;border-radius:8px;}
</style>
</head>

<body>

<div class="container">
  <div class="header">
    <h1>Admin Portal Sistem Permohonan</h1>
    <p class="subtitle">Dicipta oleh UPSI Holdings Sdn. Bhd.</p>
    <button class="logout" onclick="logout()">Log Keluar</button>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('qr')">Jana QR Code</div>
    <div class="tab" onclick="switchTab('permohonan')">Senarai Permohonan</div>
  </div>

  <!-- QR SECTION -->
  <div id="qrSection" class="content-section active">
    <div class="qr-grid" id="qrGrid"></div>
  </div>

  <!-- PERMOHONAN SECTION -->
  <div id="permohonanSection" class="content-section">
    <div class="filter-bar">
      <select id="filterJenis" onchange="applyFilter()">
        <option value="all">Semua</option>
        <option value="Alat Tulis">Alat Tulis</option>
        <option value="Kenderaan">Kenderaan</option>
        <option value="Projektor">Projektor</option>
        <option value="Kertas A4">Kertas A4</option>
      </select>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Jenis</th>
            <th>Nama</th>
            <th>Jabatan</th>
            <th>Kuantiti</th>
            <th>Tarikh</th>
          </tr>
        </thead>
        <tbody id="permohonanTable">
          <tr><td colspan="6" class="loading">Memuatkan data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ====== SECURITY ======
if(sessionStorage.getItem('isLoggedIn')!=='true'){
  window.location.href='adminlogin.html';
}
function logout(){
  sessionStorage.clear();
  window.location.href='adminlogin.html';
}

// ====== DATA QR (4 SHEET SAHAJA) ======
const SESSION_URLS = [
  { label:"Alat Tulis", url:"https://script.google.com/macros/s/AKfycbzteaAicSGci8gjiy6qZq8PslluWWRfZNOhu7dC_8gnrU8RHuseFglRKVfFygpzk1Eu/exec" },
  { label:"Kenderaan", url:"https://script.google.com/macros/s/AKfycbwnujNL7Zvaryk71udEAIjHYYrHym-zXLgI8p-HB1TH4zFdmf_czTIcWazRj_vZ1vhrig/exec" },
  { label:"Projektor", url:"https://script.google.com/macros/s/AKfycbywBA3URsRomdjq2lH_zLKn0PYivCOVn6AgFWINVPQfScYXUq2SlMoOvmi-WhfcRbjP/exec" },
  { label:"Kertas A4", url:"https://script.google.com/macros/s/AKfycbwoDHhFJuucCtB-Lt0VJLWQ7sq_U7UmXoRip_hD_WFqFT0Z6ml7vbuyFExw3f8ByTkZ/exec" }
];

// ====== TAB ======
function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
  if(tab==='qr'){
    document.querySelectorAll('.tab')[0].classList.add('active');
    document.getElementById('qrSection').classList.add('active');
    generateQRCodes();
  }else{
    document.querySelectorAll('.tab')[1].classList.add('active');
    document.getElementById('permohonanSection').classList.add('active');
    loadPermohonan();
  }
}

// ====== QR GENERATOR (LABEL IKUT SHEET) ======
function generateQRCodes(){
  const grid=document.getElementById('qrGrid');
  grid.innerHTML='';
  SESSION_URLS.forEach((item,i)=>{
    const card=document.createElement('div');
    card.className='qr-card';
    card.innerHTML=`
      <h3>QR ${item.label}</h3>
      <div class="qr-code-container" id="qr${i}"></div>
      <button class="download-btn"
        onclick="downloadQR('qr${i}','QR_${item.label.replace(/\s+/g,'_')}')">
        Muat Turun QR Code
      </button>`;
    grid.appendChild(card);
    new QRCode(document.getElementById(`qr${i}`),{
      text:item.url,width:200,height:200,
      colorDark:"#1A2350",colorLight:"#fff",
      correctLevel:QRCode.CorrectLevel.H
    });
  });
}

function downloadQR(id,name){
  const canvas=document.querySelector(`#${id} canvas`);
  const link=document.createElement('a');
  link.href=canvas.toDataURL();
  link.download=name+'.png';
  link.click();
}

// ====== PERMOHONAN ======
let allPermohonanData=[];
async function loadPermohonan(){
  allPermohonanData=[];
  const tbody=document.getElementById('permohonanTable');
  tbody.innerHTML='<tr><td colspan="6" class="loading">Memuatkan...</td></tr>';
  for(const item of SESSION_URLS){
    const res=await fetch(item.url);
    const data=await res.json();
    if(Array.isArray(data)) allPermohonanData=allPermohonanData.concat(data);
  }
  displayPermohonan(allPermohonanData);
}

function displayPermohonan(data){
  const tbody=document.getElementById('permohonanTable');
  if(!data.length){
    tbody.innerHTML='<tr><td colspan="6" class="loading">Tiada data</td></tr>';return;
  }
  tbody.innerHTML=data.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${r.JenisPermohonan||'-'}</td>
      <td>${r.Nama||'-'}</td>
      <td>${r.Jabatan||'-'}</td>
      <td>${r.Kuantiti||'-'}</td>
      <td>${r.Timestamp||'-'}</td>
    </tr>`).join('');
}

function applyFilter(){
  const v=document.getElementById('filterJenis').value;
  displayPermohonan(v==='all'?allPermohonanData:allPermohonanData.filter(r=>r.JenisPermohonan===v));
}

document.addEventListener('DOMContentLoaded',generateQRCodes);
</script>

</body>
</html>
